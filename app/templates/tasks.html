{% extends "base.html" %}

{% block title %}√ölohy - PlannerX{% endblock %}

{% block content %}
<div class="tasks-page container" style="padding-top: 2rem;">
    <div class="glass-tile page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 2rem;">
        <h1 style="color: var(--text-primary); margin: 0; font-size: 2.2rem;">üìã √ölohy</h1>
        <button class="btn btn-glass-primary" onclick="showCreateTaskModal()" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">+ Nov√° √∫loha</button>
    </div>

    <div class="glass-tile filters" style="display: flex; gap: 1rem; margin-bottom: 2rem; padding: 1.5rem;">
        <a href="/tasks?filter=all" class="btn btn-glass{% if filter == 'all' %} btn-glass-primary{% endif %}" style="text-decoration: none;">V≈°etky</a>
        <a href="/tasks?filter=today" class="btn btn-glass{% if filter == 'today' %} btn-glass-primary{% endif %}" style="text-decoration: none;">Dnes</a>
        <a href="/tasks?filter=week" class="btn btn-glass{% if filter == 'week' %} btn-glass-primary{% endif %}" style="text-decoration: none;">Tento t√Ω≈æde≈à</a>
        <a href="/tasks?filter=overdue" class="btn btn-glass{% if filter == 'overdue' %} btn-glass-primary{% endif %}" style="text-decoration: none;">Po term√≠ne</a>
    </div>

    <div class="task-list">
        {% for task in tasks %}
        <div class="glass-tile task-card priority-{{ task.priority|lower }}" data-task-id="{{ task.id }}" style="margin-bottom: 1rem; padding: 1.5rem;">
            <div class="task-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="color: var(--text-primary); margin: 0; font-size: 1.3rem;">{{ task.title }}</h3>
                <span class="priority-badge wooden-accent">{{ task.priority }}</span>
            </div>
            {% if task.notes %}
                <p class="task-notes" style="color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5;">{{ task.notes }}</p>
            {% endif %}
            <div class="task-footer" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span class="task-due" style="color: var(--text-secondary);">
                    {% if task.due_at %}
                        üïí {{ task.due_at.strftime('%d.%m.%Y %H:%M') }}
                    {% endif %}
                </span>
                <span class="task-status status-{{ task.status|lower }} wooden-accent">{{ task.status }}</span>
            </div>
            <div class="task-actions" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-glass" onclick="editTask({{ task.id }})" style="flex: 1;">‚úèÔ∏è Upravi≈•</button>
                <button class="btn btn-glass" onclick="snoozeTask({{ task.id }})" style="flex: 1;">‚è∞ Odlo≈æi≈•</button>
                <button class="btn btn-glass" onclick="deleteTask({{ task.id }})" style="flex: 1; background: rgba(239, 68, 68, 0.1); color: var(--danger);">üóëÔ∏è Zmaza≈•</button>
            </div>
        </div>
        {% else %}
        <div class="glass-tile empty-state" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-secondary); font-size: 1.2rem; margin: 0;">≈Ωiadne √∫lohy.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="taskModal" class="modal" style="display: none;">
    <div class="modal-content glass-tile" style="max-width: 500px; width: 90%; padding: 2rem;">
        <span class="close" onclick="closeTaskModal()" style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</span>
        <h2 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.8rem;">Nov√° √∫loha</h2>
        <form id="taskForm" style="display: flex; flex-direction: column; gap: 1rem;">
            <input type="text" name="title" placeholder="N√°zov √∫lohy" required class="input-glass" style="padding: 0.75rem;">
            <textarea name="notes" placeholder="Pozn√°mky" class="input-glass" style="padding: 0.75rem; min-height: 100px; resize: vertical;"></textarea>
            <input type="datetime-local" name="due_at" class="input-glass" style="padding: 0.75rem;">
            <select name="priority" class="input-glass" style="padding: 0.75rem;">
                <option value="LOW">N√≠zka priorita</option>
                <option value="MEDIUM" selected>Stredn√° priorita</option>
                <option value="HIGH">Vysok√° priorita</option>
            </select>
            <select name="status" class="input-glass" style="padding: 0.75rem;">
                <option value="TODO" selected>TODO</option>
                <option value="DOING">V procese</option>
                <option value="DONE">Hotovo</option>
            </select>
            <button type="submit" class="btn btn-glass-primary" style="padding: 0.75rem; font-size: 1.1rem;">Ulo≈æi≈•</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingTaskId = null;

function showCreateTaskModal() {
    editingTaskId = null;
    document.getElementById('taskModal').style.display = 'block';
    document.querySelector('#taskModal h2').textContent = 'Nov√° √∫loha';
    document.getElementById('taskForm').reset();
    document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈•';
}

function closeTaskModal() {
    document.getElementById('taskModal').style.display = 'none';
    editingTaskId = null;
}

async function editTask(id) {
    try {
        const response = await fetch(`/tasks/${id}`);
        if (!response.ok) {
            PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ √∫lohy', 'error');
            return;
        }
        
        const task = await response.json();
        
        // Fill form with task data
        document.querySelector('input[name="title"]').value = task.title || '';
        document.querySelector('textarea[name="notes"]').value = task.notes || '';
        document.querySelector('select[name="priority"]').value = task.priority || 'MEDIUM';
        document.querySelector('select[name="status"]').value = task.status || 'TODO';
        
        if (task.due_at) {
            const dueDate = new Date(task.due_at);
            const formattedDate = dueDate.toISOString().slice(0, 16);
            document.querySelector('input[name="due_at"]').value = formattedDate;
        }
        
        // Set editing mode
        editingTaskId = id;
        document.querySelector('#taskModal h2').textContent = 'Upravi≈• √∫lohu';
        document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈• zmeny';
        document.getElementById('taskModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading task:', error);
        PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ √∫lohy', 'error');
    }
}

document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        let response;
        if (editingTaskId) {
            // Update existing task
            response = await fetch(`/tasks/${editingTaskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        } else {
            // Create new task
            response = await fetch('/tasks/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        }
        
        if (response.ok) {
            location.reload();
        } else {
            const errorMsg = editingTaskId ? 'Chyba pri √∫prave √∫lohy' : 'Chyba pri vytv√°ran√≠ √∫lohy';
            PlannerX.showNotification(errorMsg, 'error');
        }
    } catch (error) {
        console.error('Error saving task:', error);
        PlannerX.showNotification('Chyba pri ukladan√≠ √∫lohy', 'error');
    }
});

async function deleteTask(id) {
    if (!confirm('Naozaj chcete zmaza≈• t√∫to √∫lohu?')) return;
    
    try {
        const response = await fetch(`/tasks/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            PlannerX.showNotification('Chyba pri mazan√≠ √∫lohy', 'error');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        PlannerX.showNotification('Chyba pri mazan√≠ √∫lohy', 'error');
    }
}

async function snoozeTask(id) {
    try {
        const response = await fetch(`/tasks/${id}/snooze`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            PlannerX.showNotification('Chyba pri odlo≈æen√≠ √∫lohy', 'error');
        }
    } catch (error) {
        console.error('Error snoozing task:', error);
        PlannerX.showNotification('Chyba pri odlo≈æen√≠ √∫lohy', 'error');
    }
}
</script>
{% endblock %}
