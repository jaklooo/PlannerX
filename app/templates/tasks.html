{% extends "base.html" %}

{% block title %}√ölohy - PlannerX{% endblock %}

{% block content %}
<div class="tasks-page">
    <div class="page-header">
        <h1>üìã √ölohy</h1>
        <button class="btn btn-primary" onclick="showCreateTaskModal()">+ Nov√° √∫loha</button>
    </div>

    <div class="filters">
        <a href="/tasks?filter=all" class="filter-btn {% if filter == 'all' %}active{% endif %}">V≈°etky</a>
        <a href="/tasks?filter=today" class="filter-btn {% if filter == 'today' %}active{% endif %}">Dnes</a>
        <a href="/tasks?filter=week" class="filter-btn {% if filter == 'week' %}active{% endif %}">Tento t√Ω≈æde≈à</a>
        <a href="/tasks?filter=overdue" class="filter-btn {% if filter == 'overdue' %}active{% endif %}">Po term√≠ne</a>
    </div>

    <div class="task-list">
        {% for task in tasks %}
        <div class="task-card priority-{{ task.priority|lower }}" data-task-id="{{ task.id }}">
            <div class="task-header">
                <h3>{{ task.title }}</h3>
                <span class="priority-badge">{{ task.priority }}</span>
            </div>
            {% if task.notes %}
                <p class="task-notes">{{ task.notes }}</p>
            {% endif %}
            <div class="task-footer">
                <span class="task-due">
                    {% if task.due_at %}
                        üïí {{ task.due_at.strftime('%d.%m.%Y %H:%M') }}
                    {% endif %}
                </span>
                <span class="task-status status-{{ task.status|lower }}">{{ task.status }}</span>
            </div>
            <div class="task-actions">
                <button onclick="editTask({{ task.id }})">‚úèÔ∏è Upravi≈•</button>
                <button onclick="snoozeTask({{ task.id }})">‚è∞ Odlo≈æi≈•</button>
                <button onclick="deleteTask({{ task.id }})">üóëÔ∏è Zmaza≈•</button>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <p>≈Ωiadne √∫lohy.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="taskModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeTaskModal()">&times;</span>
        <h2>Nov√° √∫loha</h2>
        <form id="taskForm">
            <input type="text" name="title" placeholder="N√°zov √∫lohy" required>
            <textarea name="notes" placeholder="Pozn√°mky"></textarea>
            <input type="datetime-local" name="due_at">
            <select name="priority">
                <option value="LOW">N√≠zka priorita</option>
                <option value="MEDIUM" selected>Stredn√° priorita</option>
                <option value="HIGH">Vysok√° priorita</option>
            </select>
            <select name="status">
                <option value="TODO" selected>TODO</option>
                <option value="DOING">V procese</option>
                <option value="DONE">Hotovo</option>
            </select>
            <button type="submit" class="btn btn-primary">Ulo≈æi≈•</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingTaskId = null;

function showCreateTaskModal() {
    editingTaskId = null;
    document.getElementById('taskModal').style.display = 'block';
    document.querySelector('#taskModal h2').textContent = 'Nov√° √∫loha';
    document.getElementById('taskForm').reset();
    document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈•';
}

function closeTaskModal() {
    document.getElementById('taskModal').style.display = 'none';
    editingTaskId = null;
}

async function editTask(id) {
    try {
        const response = await fetch(`/tasks/${id}`);
        if (!response.ok) {
            PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ √∫lohy', 'error');
            return;
        }
        
        const task = await response.json();
        
        // Fill form with task data
        document.querySelector('input[name="title"]').value = task.title || '';
        document.querySelector('textarea[name="notes"]').value = task.notes || '';
        document.querySelector('select[name="priority"]').value = task.priority || 'MEDIUM';
        document.querySelector('select[name="status"]').value = task.status || 'TODO';
        
        if (task.due_at) {
            const dueDate = new Date(task.due_at);
            const formattedDate = dueDate.toISOString().slice(0, 16);
            document.querySelector('input[name="due_at"]').value = formattedDate;
        }
        
        // Set editing mode
        editingTaskId = id;
        document.querySelector('#taskModal h2').textContent = 'Upravi≈• √∫lohu';
        document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈• zmeny';
        document.getElementById('taskModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading task:', error);
        PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ √∫lohy', 'error');
    }
}

document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        let response;
        if (editingTaskId) {
            // Update existing task
            response = await fetch(`/tasks/${editingTaskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        } else {
            // Create new task
            response = await fetch('/tasks/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        }
        
        if (response.ok) {
            location.reload();
        } else {
            const errorMsg = editingTaskId ? 'Chyba pri √∫prave √∫lohy' : 'Chyba pri vytv√°ran√≠ √∫lohy';
            PlannerX.showNotification(errorMsg, 'error');
        }
    } catch (error) {
        console.error('Error saving task:', error);
        PlannerX.showNotification('Chyba pri ukladan√≠ √∫lohy', 'error');
    }
});

async function deleteTask(id) {
    if (!confirm('Naozaj chcete zmaza≈• t√∫to √∫lohu?')) return;
    
    try {
        const response = await fetch(`/tasks/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            PlannerX.showNotification('Chyba pri mazan√≠ √∫lohy', 'error');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        PlannerX.showNotification('Chyba pri mazan√≠ √∫lohy', 'error');
    }
}

async function snoozeTask(id) {
    try {
        const response = await fetch(`/tasks/${id}/snooze`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            PlannerX.showNotification('Chyba pri odlo≈æen√≠ √∫lohy', 'error');
        }
    } catch (error) {
        console.error('Error snoozing task:', error);
        PlannerX.showNotification('Chyba pri odlo≈æen√≠ √∫lohy', 'error');
    }
}
</script>
{% endblock %}
