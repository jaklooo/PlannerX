{% extends "base.html" %}

{% block title %}Udalosti - PlannerX{% endblock %}

{% block content %}
<div class="events-page container" style="padding-top: 2rem;">
    <div class="glass-tile page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 2rem;">
        <h1 style="color: var(--text-primary); margin: 0; font-size: 2.2rem;">üìÖ Udalosti</h1>
        <button class="btn btn-glass-primary" onclick="showCreateEventModal()" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">+ Nov√° udalos≈•</button>
    </div>

    <div class="event-list">
        {% for item in events %}
        <div class="glass-tile event-card" data-event-id="{{ item.event.id }}" style="margin-bottom: 1rem; padding: 1.5rem;">
            <div class="event-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="color: var(--text-primary); margin: 0; font-size: 1.3rem;">{{ item.event.title }}</h3>
                {% if item.event.repeat_rule %}
                    <span class="event-repeat wooden-accent">{{ item.event.repeat_rule }}</span>
                {% endif %}
            </div>
            {% if item.event.description %}
                <p class="event-description" style="color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5;">{{ item.event.description }}</p>
            {% endif %}
            <div class="event-details" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                <span style="color: var(--wood-accent); font-weight: 600;">üïí {{ item.occurrence_date.strftime('%d.%m.%Y') }} {{ item.event.start_at.strftime('%H:%M') }}</span>
                {% if item.event.location %}
                    <span style="color: var(--text-secondary);">üìç {{ item.event.location }}</span>
                {% endif %}
            </div>
            <div class="event-actions" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-glass" onclick="editEvent({{ item.event.id }})" style="flex: 1;">‚úèÔ∏è Upravi≈•</button>
                <button class="btn btn-glass" onclick="deleteEvent({{ item.event.id }})" style="flex: 1; background: rgba(239, 68, 68, 0.1); color: var(--danger);">üóëÔ∏è Zmaza≈•</button>
            </div>
        </div>
        {% else %}
        <div class="glass-tile empty-state" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-secondary); font-size: 1.2rem; margin: 0;">≈Ωiadne udalosti.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="eventModal" class="modal" style="display: none;">
    <div class="modal-content glass-tile" style="max-width: 500px; width: 90%; padding: 2rem;">
        <span class="close" onclick="closeEventModal()" style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</span>
        <h2 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.8rem;">Nov√° udalos≈•</h2>
        <form id="eventForm" style="display: flex; flex-direction: column; gap: 1rem;">
            <input type="text" name="title" placeholder="N√°zov udalosti" required class="input-glass" style="padding: 0.75rem;">
            <textarea name="description" placeholder="Popis" class="input-glass" style="padding: 0.75rem; min-height: 100px; resize: vertical;"></textarea>
            <input type="text" name="location" placeholder="Miesto" class="input-glass" style="padding: 0.75rem;">
            <input type="datetime-local" name="start_at" required class="input-glass" style="padding: 0.75rem;">
            <input type="datetime-local" name="end_at" class="input-glass" style="padding: 0.75rem;">
            <select name="repeat_rule" class="input-glass" style="padding: 0.75rem;">
                <option value="NONE" selected>Bez opakovania</option>
                <option value="DAILY">Denne</option>
                <option value="WEEKLY">T√Ω≈ædenne</option>
                <option value="MONTHLY">Mesaƒçne</option>
            </select>
            <button type="submit" class="btn btn-glass-primary" style="padding: 0.75rem; font-size: 1.1rem;">Ulo≈æi≈•</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingEventId = null;

function showCreateEventModal() {
    editingEventId = null;
    document.getElementById('eventModal').style.display = 'block';
    document.querySelector('#eventModal h2').textContent = 'Nov√° udalos≈•';
    document.getElementById('eventForm').reset();
    document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈•';
}

function closeEventModal() {
    document.getElementById('eventModal').style.display = 'none';
    editingEventId = null;
}

async function editEvent(id) {
    try {
        const response = await fetch(`/events/${id}`);
        if (!response.ok) {
            PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ udalosti', 'error');
            return;
        }
        
        const event = await response.json();
        
        // Fill form with event data
        document.querySelector('input[name="title"]').value = event.title || '';
        document.querySelector('textarea[name="description"]').value = event.description || '';
        document.querySelector('input[name="location"]').value = event.location || '';
        document.querySelector('select[name="repeat_rule"]').value = event.repeat_rule || 'NONE';
        
        if (event.start_at) {
            const startDate = new Date(event.start_at);
            const formattedStart = startDate.toISOString().slice(0, 16);
            document.querySelector('input[name="start_at"]').value = formattedStart;
        }
        
        if (event.end_at) {
            const endDate = new Date(event.end_at);
            const formattedEnd = endDate.toISOString().slice(0, 16);
            document.querySelector('input[name="end_at"]').value = formattedEnd;
        }
        
        // Set editing mode
        editingEventId = id;
        document.querySelector('#eventModal h2').textContent = 'Upravi≈• udalos≈•';
        document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈• zmeny';
        document.getElementById('eventModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading event:', error);
        PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ udalosti', 'error');
    }
}

document.getElementById('eventForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        let response;
        if (editingEventId) {
            // Update existing event
            response = await fetch(`/events/${editingEventId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        } else {
            // Create new event
            response = await fetch('/events/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        }
        
        if (response.ok) {
            location.reload();
        } else {
            const errorMsg = editingEventId ? 'Chyba pri √∫prave udalosti' : 'Chyba pri vytv√°ran√≠ udalosti';
            PlannerX.showNotification(errorMsg, 'error');
        }
    } catch (error) {
        console.error('Error saving event:', error);
        PlannerX.showNotification('Chyba pri ukladan√≠ udalosti', 'error');
    }
});

async function deleteEvent(id) {
    if (!confirm('Naozaj chcete zmaza≈• t√∫to udalos≈•?')) return;
    
    try {
        const response = await fetch(`/events/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            PlannerX.showNotification('Chyba pri mazan√≠ udalosti', 'error');
        }
    } catch (error) {
        console.error('Error deleting event:', error);
        PlannerX.showNotification('Chyba pri mazan√≠ udalosti', 'error');
    }
}
</script>
{% endblock %}
