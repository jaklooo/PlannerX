{% extends "base.html" %}

{% block title %}Kontakty - PlannerX{% endblock %}

{% block content %}
<div class="contacts-page container" style="padding-top: 2rem;">
    <div class="glass-tile page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 2rem;">
        <h1 style="color: var(--text-primary); margin: 0; font-size: 2.2rem;">üë• Kontakty</h1>
        <button class="btn btn-glass-primary" onclick="showCreateContactModal()" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">+ Nov√Ω kontakt</button>
    </div>

    <div class="contact-list">
        {% for contact in contacts %}
        <div class="glass-tile contact-card" data-contact-id="{{ contact.id }}" style="margin-bottom: 1rem; padding: 1.5rem;">
            <div class="contact-header" style="margin-bottom: 1rem;">
                <h3 style="color: var(--text-primary); margin: 0; font-size: 1.3rem;">{{ contact.name }}</h3>
            </div>
            <div class="contact-details" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                {% if contact.email %}
                    <p style="color: var(--text-secondary); margin: 0;">‚úâÔ∏è {{ contact.email }}</p>
                {% endif %}
                {% if contact.phone %}
                    <p style="color: var(--text-secondary); margin: 0;">üì± {{ contact.phone }}</p>
                {% endif %}
                {% if contact.birthday_date %}
                    <p style="color: var(--wood-accent); margin: 0; font-weight: 600;">üéÇ Narodeniny: {{ contact.birthday_date.strftime('%d.%m.%Y') }}</p>
                {% endif %}
                {% if contact.name_day_date %}
                    <p style="color: var(--wood-accent); margin: 0; font-weight: 600;">üéâ Meniny: {{ contact.name_day_date.strftime('%d.%m') }}</p>
                {% endif %}
            </div>
            <div class="contact-actions" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-glass" onclick="editContact({{ contact.id }})" style="flex: 1;">‚úèÔ∏è Upravi≈•</button>
                <button class="btn btn-glass" onclick="deleteContact({{ contact.id }})" style="flex: 1; background: rgba(239, 68, 68, 0.1); color: var(--danger);">üóëÔ∏è Zmaza≈•</button>
            </div>
        </div>
        {% else %}
        <div class="glass-tile empty-state" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-secondary); font-size: 1.2rem; margin: 0;">≈Ωiadne kontakty.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="contactModal" class="modal" style="display: none;">
    <div class="modal-content glass-tile" style="max-width: 500px; width: 90%; padding: 2rem;">
        <span class="close" onclick="closeContactModal()" style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</span>
        <h2 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.8rem;">Nov√Ω kontakt</h2>
        <form id="contactForm" style="display: flex; flex-direction: column; gap: 1rem;">
            <input type="text" name="name" placeholder="Meno" required class="input-glass" style="padding: 0.75rem;">
            <input type="email" name="email" placeholder="Email" class="input-glass" style="padding: 0.75rem;">
            <input type="tel" name="phone" placeholder="Telef√≥n" class="input-glass" style="padding: 0.75rem;">
            <input type="date" name="birthday_date" placeholder="Narodeniny" class="input-glass" style="padding: 0.75rem;">
            <input type="date" name="name_day_date" placeholder="Meniny (DD-MM)" class="input-glass" style="padding: 0.75rem;">
            <textarea name="notes" placeholder="Pozn√°mky" class="input-glass" style="padding: 0.75rem; min-height: 100px; resize: vertical;"></textarea>
            <button type="submit" class="btn btn-glass-primary" style="padding: 0.75rem; font-size: 1.1rem;">Ulo≈æi≈•</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingContactId = null;

function showCreateContactModal() {
    editingContactId = null;
    document.getElementById('contactModal').style.display = 'block';
    document.querySelector('#contactModal h2').textContent = 'Nov√Ω kontakt';
    document.getElementById('contactForm').reset();
    document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈•';
}

function closeContactModal() {
    document.getElementById('contactModal').style.display = 'none';
    editingContactId = null;
}

async function editContact(id) {
    try {
        const response = await fetch(`/contacts/${id}`);
        if (!response.ok) {
            PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ kontaktu', 'error');
            return;
        }
        
        const contact = await response.json();
        
        // Fill form with contact data
        document.querySelector('input[name="name"]').value = contact.name || '';
        document.querySelector('input[name="email"]').value = contact.email || '';
        document.querySelector('input[name="phone"]').value = contact.phone || '';
        document.querySelector('textarea[name="notes"]').value = contact.notes || '';
        
        if (contact.birthday_date) {
            const birthday = new Date(contact.birthday_date);
            const formattedBirthday = birthday.toISOString().split('T')[0];
            document.querySelector('input[name="birthday_date"]').value = formattedBirthday;
        }
        
        if (contact.name_day_date) {
            // name_day_date is stored as MM-DD, convert to YYYY-MM-DD for input
            const currentYear = new Date().getFullYear();
            const [month, day] = contact.name_day_date.split('-');
            const nameDay = new Date(currentYear, parseInt(month) - 1, parseInt(day));
            const formattedNameDay = nameDay.toISOString().split('T')[0];
            document.querySelector('input[name="name_day_date"]').value = formattedNameDay;
        }
        
        // Set editing mode
        editingContactId = id;
        document.querySelector('#contactModal h2').textContent = 'Upravi≈• kontakt';
        document.querySelector('button[type="submit"]').textContent = 'Ulo≈æi≈• zmeny';
        document.getElementById('contactModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading contact:', error);
        PlannerX.showNotification('Chyba pri naƒç√≠tan√≠ kontaktu', 'error');
    }
}

document.getElementById('contactForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // Convert birthday_date and name_day_date formats
    if (data.birthday_date) {
        data.birthday_date = data.birthday_date; // Already in YYYY-MM-DD format
    }
    
    if (data.name_day_date) {
        // Convert from YYYY-MM-DD back to MM-DD for name_day_date
        const date = new Date(data.name_day_date);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        data.name_day_date = `${month}-${day}`;
    }
    
    try {
        let response;
        if (editingContactId) {
            // Update existing contact
            response = await fetch(`/contacts/${editingContactId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        } else {
            // Create new contact
            response = await fetch('/contacts/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        }
        
        if (response.ok) {
            location.reload();
        } else {
            const errorMsg = editingContactId ? 'Chyba pri √∫prave kontaktu' : 'Chyba pri vytv√°ran√≠ kontaktu';
            PlannerX.showNotification(errorMsg, 'error');
        }
    } catch (error) {
        console.error('Error saving contact:', error);
        PlannerX.showNotification('Chyba pri ukladan√≠ kontaktu', 'error');
    }
});

async function deleteContact(id) {
    if (!confirm('Naozaj chcete zmaza≈• tento kontakt?')) return;
    
    try {
        const response = await fetch(`/contacts/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            PlannerX.showNotification('Chyba pri mazan√≠ kontaktu', 'error');
        }
    } catch (error) {
        console.error('Error deleting contact:', error);
        PlannerX.showNotification('Chyba pri mazan√≠ kontaktu', 'error');
    }
}
</script>
{% endblock %}
